---
layout: post
title: DNN求导
---

{{page.title}}
==============

<p class="meta">{{page.date | date_to_string}} - Beijing</p>

注：下文的专有名词如果不见特别限定(标量、矩阵)，都表示向量。
DNN的结构：[Norm, Sigmod, Softmax, CrossEntropy(CE)]
符号系统：$$z^i$$ -> 第i层的输入，$$a^i$$ -> 第i层的输出，$$W^i$$ -> 第i层的变换矩阵，$$b^i$$ -> 第i层的偏置，$$L(lables)$$ -> 先验类别布尔向量

forward propagation:
    $$z^0 = x^0$$
    $$a^0 = norm(z^0)$$
    $$z^1 = a^0 * W^1 + b1$$
    $$a^1 = sigmod(z^1)$$
    $$z^2 = a^1 * W^2 + b2$$
    $$a^2 = softmax(z^2)
    $$z^3 = a^2
    $$a^3 = ce(z^3, L)$$

cost function: 
    $$f(x, W, b, L) = a^3 $$

back propagation:

layer 3
    $$\frac{\partial f}{\partial z^3} =$$
    $$\frac{\partial CE(z^3, L)}{\partial z^3} = $$
    $$\frac{\partial{\sum_i{z^3_i * log(L_i)}}}{\partial z^3} = $$
    $$[-\frac{L_i}{a^3_i}]_{1 * colN(z^3)}= $$
    $$\delta_3$$

layer 2
    $$\frac{\partial f}{\partial z^2} = $$
    $$\frac{\partial f}{\partial z^3} * \frac{\partial z^3}{\partial z^2} = $$
    $$\delta_3 * \frac{\partial z^3}{\partial z^2} = $$
    $$\delta_3 * \frac{\partial softmax(z^2)}{\partial z^2} = $$
    $$\delta_3 * Diag_{rowN(z^2) * colN(z^2)} \{e[i, i] = (softmax(z^2, i) * (1 - softmax(z^2, i)))\} = $$
    $$\delta_2$$
    $$\frac{\partial f}{\partial W^2} = $$
    $$\frac{\partial f}{\partial z^2} * \frac{\partial z^2}{\partial W^2} = $$
    $$\delta_2 * \frac{\partial (a^1 * W^2 + b2)}{\partial{W^2}} = $$
    $$\delta_2 * [a^1]^T_{colN(W^2)*1}$$
    $$\frac{\partial{f}}{\partial{b^2}} = $$
    $$\frac{\partial{f}}{\partial{z^2}} * \frac{\partial{z^2}}{\partial{b^2}} = $$
    $$\delta_2 * \frac{\partial{a^1 * W^2 + b2}}{\partial{b^2}} = $$
    $$\delta_2$$

layer 1
    $$\frac{\partial{f}}{\partial{z^1}} = $$
    $$\frac{\partial{f}}{\partial{z^2}} * \frac{\partial{z^2}}{\partial{z^1}} = $$
    $$\delta_2 * \frac{\partial{z^2}}{\partial{z^1}} = $$
    $$\delta_2 * \frac{\partial{sigmod(z^1)}}{\partial{z^1}} = $$
    $$\delta_2 * sigmod(z^1) .* (1 - sigmod(z^1)) = $$
    $$\delta_1$$
    $$\frac{\partial{f}}{\partial{W^1}} = $$
    $$\frac{\partial{f}}{\partial{z^1}} * \frac{\partial{z^1}}{\partial{W^1}} = $$
    $$\delta_1 * \frac{\partial (a^0 * W^1 + b1)}{\partial{W^1}} = $$
    $$\delta_1 * [a^0]^T_{colN(W^1)*1}$$
    $$\frac{\partial{f}}{\partial{b^1}} = $$
    $$\frac{\partial{f}}{\partial{z^1}} * \frac{\partial{z^1}}{\partial{b^1}} = $$
    $$\delta_1 * \frac{\partial (a^0 * W^1 + b1)}{\partial{b^1}} = $$
    $$\delta_1$$
